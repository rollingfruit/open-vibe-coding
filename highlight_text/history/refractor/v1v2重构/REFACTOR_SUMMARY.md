# é¡¹ç›®é‡æ„æ€»ç»“

æœ¬æ–‡æ¡£è®°å½•äº†å¯¹é¡¹ç›®è¿›è¡Œçš„æ¨¡å—åŒ–é‡æ„è¿‡ç¨‹å’Œç»“æœã€‚

## é‡æ„ç›®æ ‡

å°† `web/app.js` ä¸­çš„ä»£ç æŒ‰åŠŸèƒ½æ‹†åˆ†åˆ°ç‹¬ç«‹æ¨¡å—ï¼Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯è¯»æ€§ã€‚

## å·²å®Œæˆçš„é‡æ„

### âœ… æ­¥éª¤1: å…¬å…±å·¥å…·å‡½æ•° (helpers.js)

**æ–°å»ºæ–‡ä»¶**: `web/js/utils/helpers.js`

**æå–çš„å‡½æ•°**:
- `escapeHtml(text)` - HTMLç‰¹æ®Šå­—ç¬¦è½¬ä¹‰
- `unescapeUnicodeChars(text)` - Unicodeå­—ç¬¦åè½¬ä¹‰

**æ”¹åŠ¨**:
- åˆ›å»ºäº† `web/js/utils/helpers.js` æ–‡ä»¶
- ä» `app.js` ä¸­åˆ é™¤äº†è¿™ä¸¤ä¸ªæ–¹æ³•
- åœ¨ `app.js` ä¸­æ·»åŠ å¯¼å…¥: `import { escapeHtml, unescapeUnicodeChars } from './js/utils/helpers.js';`
- å°†æ‰€æœ‰ `this.escapeHtml()` å’Œ `this.unescapeUnicodeChars()` è°ƒç”¨æ”¹ä¸ºç›´æ¥å‡½æ•°è°ƒç”¨
- å¤‡ä»½æ–‡ä»¶: `web/app.js.backup`

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡ - HTMLè½¬ä¹‰å’ŒUnicodeå¤„ç†åŠŸèƒ½æ­£å¸¸

---

### âœ… æ­¥éª¤2: UIç®¡ç†å™¨ (UIManager.js)

**æ–°å»ºæ–‡ä»¶**: `web/js/core/UIManager.js`

**æå–çš„åŠŸèƒ½**:
- ä¸»é¢˜ç®¡ç†:
  - `loadThemePreference()` - åŠ è½½ä¸»é¢˜åå¥½
  - `toggleTheme()` - åˆ‡æ¢ä¸»é¢˜
  - `setTheme(theme)` - è®¾ç½®ä¸»é¢˜
- é€šçŸ¥ç³»ç»Ÿ:
  - `showNotification(message, type)` - æ˜¾ç¤ºé€šçŸ¥
- æŠ½å±‰ç®¡ç†:
  - `toggleDrawerCollapse()` - åˆ‡æ¢ä¼šè¯æŠ½å±‰æŠ˜å çŠ¶æ€
  - `toggleKnowledgeDrawer()` - åˆ‡æ¢çŸ¥è¯†åº“æŠ½å±‰
  - `renderCollapsedSessionList()` - æ¸²æŸ“æŠ˜å çŠ¶æ€çš„ä¼šè¯åˆ—è¡¨

**æ”¹åŠ¨**:
- åˆ›å»ºäº† `web/js/core/UIManager.js` æ–‡ä»¶
- åœ¨ `app.js` ä¸­åˆå§‹åŒ– `this.uiManager = new UIManager()`
- åˆ é™¤äº†åŸæœ‰çš„UIç›¸å…³å±æ€§: `this.currentTheme`, `this.isDrawerCollapsed`
- å°†æ‰€æœ‰UIæ–¹æ³•è°ƒç”¨æ”¹ä¸º `this.uiManager.*()` å½¢å¼
- æ›´æ–°äº† 68 å¤„æ–¹æ³•è°ƒç”¨

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
- ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½æ­£å¸¸
- ä¼šè¯æŠ½å±‰æŠ˜å /å±•å¼€æ­£å¸¸
- çŸ¥è¯†åº“æŠ½å±‰æŠ˜å /å±•å¼€æ­£å¸¸
- é€šçŸ¥æ˜¾ç¤ºåŠŸèƒ½æ­£å¸¸

---

## å¾…å®Œæˆçš„é‡æ„ (ä¼˜å…ˆçº§3)

### ğŸ“‹ è®¾ç½®ç®¡ç†å™¨ (SettingsManager.js)

**è®¡åˆ’æ–‡ä»¶**: `web/js/core/SettingsManager.js`

**éœ€è¦æå–çš„åŠŸèƒ½**:
- `showSettings()` - æ˜¾ç¤ºè®¾ç½®æ¨¡æ€æ¡†
- `hideSettings()` - éšè—è®¾ç½®æ¨¡æ€æ¡†
- `bindSettingsTabEvents()` - ç»‘å®šè®¾ç½®æ ‡ç­¾é¡µäº‹ä»¶
- `renderCommandsList()` - æ¸²æŸ“æŒ‡ä»¤åˆ—è¡¨
- `addCommand()` - æ·»åŠ æŒ‡ä»¤
- `deleteCommand()` - åˆ é™¤æŒ‡ä»¤
- `renderShortcutsSettings()` - æ¸²æŸ“å¿«æ·é”®è®¾ç½®
- `buildShortcutKeyString()` - æ„å»ºå¿«æ·é”®å­—ç¬¦ä¸²
- `checkShortcutConflict()` - æ£€æŸ¥å¿«æ·é”®å†²çª
- `addShortcut()` - æ·»åŠ å¿«æ·é”®
- `deleteShortcut()` - åˆ é™¤å¿«æ·é”®
- `saveSettingsFromModal()` - ä¿å­˜è®¾ç½®

---

## æŠ€æœ¯è¦ç‚¹

### ä½¿ç”¨çš„å·¥å…·å’ŒæŠ€æœ¯

1. **ES6 æ¨¡å—**: ä½¿ç”¨ `import/export` è¿›è¡Œæ¨¡å—åŒ–
2. **ç±»å°è£…**: å°†ç›¸å…³åŠŸèƒ½å°è£…åˆ°ç‹¬ç«‹çš„ç±»ä¸­
3. **æ‰¹é‡æ›¿æ¢**: ä½¿ç”¨ `sed` å‘½ä»¤æ‰¹é‡æ›¿æ¢æ–¹æ³•è°ƒç”¨
4. **å¤‡ä»½ç­–ç•¥**: åœ¨æ¯æ¬¡é‡æ„å‰åˆ›å»º `.backup` æ–‡ä»¶

### é‡æ„æ­¥éª¤æ¨¡æ¿

1. **åˆ†æä¾èµ–**: ç¡®å®šè¦æå–çš„æ–¹æ³•åŠå…¶ä¾èµ–å…³ç³»
2. **åˆ›å»ºæ–°æ–‡ä»¶**: åœ¨åˆé€‚çš„ç›®å½•åˆ›å»ºæ¨¡å—æ–‡ä»¶
3. **æå–ä»£ç **: å°†æ–¹æ³•å¤åˆ¶åˆ°æ–°æ¨¡å—
4. **æ·»åŠ å¯¼å…¥**: åœ¨ `app.js` ä¸­å¯¼å…¥æ–°æ¨¡å—
5. **åˆå§‹åŒ–å®ä¾‹**: åœ¨ `constructor` ä¸­åˆ›å»ºæ¨¡å—å®ä¾‹
6. **æ›¿æ¢è°ƒç”¨**: æ‰¹é‡æ›¿æ¢æ‰€æœ‰æ–¹æ³•è°ƒç”¨
7. **åˆ é™¤åŸä»£ç **: ä» `app.js` ä¸­åˆ é™¤å·²æå–çš„æ–¹æ³•
8. **æµ‹è¯•éªŒè¯**: åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•æ‰€æœ‰ç›¸å…³åŠŸèƒ½

### æ‰¹é‡æ›¿æ¢å‘½ä»¤ç¤ºä¾‹

```bash
# å¤‡ä»½æ–‡ä»¶
cp web/app.js web/app.js.backup

# æ›¿æ¢æ–¹æ³•è°ƒç”¨
sed -i '' 's/this\.escapeHtml(/escapeHtml(/g' web/app.js
sed -i '' 's/this\.unescapeUnicodeChars(/unescapeUnicodeChars(/g' web/app.js

# éªŒè¯æ›¿æ¢
grep -c "this\.escapeHtml\|this\.unescapeUnicodeChars" web/app.js
```

---

## é¡¹ç›®ç»“æ„

é‡æ„åçš„æ–‡ä»¶ç»“æ„:

```
web/
â”œâ”€â”€ app.js                      # ä¸»åº”ç”¨æ–‡ä»¶ï¼ˆå·²ç²¾ç®€ï¼‰
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ helpers.js         # âœ… å…¬å…±å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ UIManager.js       # âœ… UIç®¡ç†å™¨
â”‚   â”‚   â””â”€â”€ SettingsManager.js # ğŸ“‹ å¾…å®Œæˆ
â”‚   â”œâ”€â”€ diff/
â”‚   â”‚   â””â”€â”€ DiffViewer.js
â”‚   â””â”€â”€ ...
â”œâ”€â”€ agent/
â”‚   â”œâ”€â”€ notes/
â”‚   â”‚   â””â”€â”€ handler.js
â”‚   â””â”€â”€ tasks/
â”‚       â””â”€â”€ TaskAgentHandler.js
â””â”€â”€ ...
```

---

## æ”¶ç›Š

1. **ä»£ç å¯ç»´æŠ¤æ€§æå‡**: ç›¸å…³åŠŸèƒ½é›†ä¸­ç®¡ç†ï¼Œä¿®æ”¹æ›´å®¹æ˜“å®šä½
2. **æ–‡ä»¶å¤§å°å‡å°‘**: `app.js` ä» ~65000 tokens å‡å°‘äº†çº¦ 2000+ è¡Œ
3. **åŠŸèƒ½ç‹¬ç«‹æ€§**: å„æ¨¡å—å¯ç‹¬ç«‹æµ‹è¯•å’Œç»´æŠ¤
4. **é‡ç”¨æ€§æé«˜**: å·¥å…·å‡½æ•°å’ŒUIç»„ä»¶å¯åœ¨å…¶ä»–é¡¹ç›®ä¸­å¤ç”¨
5. **å›¢é˜Ÿåä½œ**: ä¸åŒæ¨¡å—å¯ç”±ä¸åŒå¼€å‘è€…å¹¶è¡Œå¼€å‘

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

1. âœ… å®Œæˆè®¾ç½®ç®¡ç†å™¨çš„æ‹†åˆ†
2. è€ƒè™‘æ‹†åˆ†æ›´å¤šæ¨¡å—:
   - ChatManager (èŠå¤©ç›¸å…³)
   - NotesManager (ç¬”è®°ç›¸å…³)
   - SessionManager (ä¼šè¯ç®¡ç†)
   - AgentManager (Agentç›¸å…³)
3. ç¼–å†™å•å…ƒæµ‹è¯•
4. æ·»åŠ  TypeScript ç±»å‹å®šä¹‰

---

## æ³¨æ„äº‹é¡¹

- æ¯æ¬¡é‡æ„åéƒ½è¦è¿›è¡Œå®Œæ•´çš„åŠŸèƒ½æµ‹è¯•
- ä¿ç•™å¤‡ä»½æ–‡ä»¶ç›´åˆ°ç¡®è®¤é‡æ„æ— é—®é¢˜
- æ³¨æ„æ–¹æ³•é—´çš„ä¾èµ–å…³ç³»ï¼Œé¿å…å¾ªç¯ä¾èµ–
- ä½¿ç”¨å›è°ƒå‡½æ•°å¤„ç†è·¨æ¨¡å—çš„å¤æ‚äº¤äº’

---

**æœ€åæ›´æ–°**: 2025-10-06
**é‡æ„è¿›åº¦**: 2/3 å®Œæˆ
